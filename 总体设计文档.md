# 总体设计文档

版本：1.0  
作者：曹家茗
日期：2025-12-30

---

## 一、项目名称 / 文档作者
- 项目名称：Bookstore-2025  
- 文档作者：曹家茗

---

## 二、程序功能概述
Bookstore-2025 是基于命令行的图书管理与销售系统（单进程、单线程）。主要功能：
- 用户管理：注册（register）、登录（su）、登出（logout）、修改密码（passwd）、添加用户（useradd）、删除用户（delete）
- 图书管理：按 ISBN/name/author/keyword 查询并显示（show）、增加新书记录（select）、修改书目信息（modify）、导入进货（import）、查询全部（show -all）
- 购买功能：顾客购买图书（buy），购买时会判断库存并扣减数量，同时产生日志与财务记录
- 日志与报表：操作日志（log）、财务报表（report finance）、员工报表（report employee）、显示最近若干次交易（show finance N）
- 持久化：以若干固定格式的二进制文件保存数据（见“数据库设计”）
- 基本权限控制：三种主要权限等级（1、3、7）用于区分普通用户、店员（或员工）与管理员（root）

程序启动时会读取/初始化二进制数据文件（totalFile、AccountFile、BookFile、transactionLogFile、operationLogFile、financeReportFile、employeeReportFile 等）；
程序退出时会记录当前管理器状态回 totalFile 并关闭文件。

默认仓库代码在 Program 构造时若无 totalFile 会创建一个 root 用户：
- userid: "root", password: "sjtu", privilege: 7, username: "caojiaming"

---

## 三、主体逻辑说明
程序采用“Parser（输入解析） -> Program（应用协调） -> 各 Manager（功能实现） -> 二进制文件持久化”的流程：

1. 启动：
   - 程序打开/创建 totalFile（用于记录各子管理器在 totalFile 的元信息）。
   - 各 Manager（AccountManager、BookManager、LogManager）尝试从 totalFile 中读取自身记录信息（通过 setXXXManager）并打开/创建各自专属文件（AccountFile、BookFile、transactionLogFile 等）。

2. 命令循环：
   - 用户输入一行命令由 Parser::parseLine 分发到各种parse函数（每个parse函数代表一种或一类语句）并解析（语法与参数校验），解析通过后调用 Program 中相应方法（如 Su, Register, Buy, Select, Modify, Import, Show, Report 等）。在Program中具体实现。
   - Program 调用 AccountManager、BookManager、LogManager 等实现具体操作并适时记录日志与财务记录。

3. 退出：
   - Program 析构时调用各 Manager 的 recordXXXManager 将必要的元信息写回 totalFile，然后关闭所有文件。

关键责任分配：
- Parser：把一行文本解析为命令与参数（包含严格的格式检查）。
- Program：校验权限/会话（loginStack 管理），协调操作并调用 Manager 完成业务。
- AccountManager：用户记录增删改查，维护账号索引（accountList）（长效）。
- BookManager：图书记录的读写、索引（ISBN、name、author、keyword）、库存修改、添加/修改书目（长效）。
- LogManager：记录操作日志、交易日志、财务明细与员工报表，并提供展示接口（长效）。
- 持久化采用固定宽度二进制记录文件，读写由各 Manager 直接操作文件流完成。

错误与异常处理：使用 BookstoreError 异常类型（utils/Error.hpp），在参数校验或状态不满足时抛出"Invalid"。

---

## 四、代码文件结构
仓库中的主要文件/目录：
- CMakeLists.txt
- src/
  - Program.cpp                         // 应用协调（会话/命令调用/文件总控）
  - Parser.cpp                          // 命令解析
  - AccountManager.cpp                  // 账号管理，账号文件 AccountFile
  - BookManager.cpp                     // 图书管理，图书文件 BookFile
  - LogManager.cpp                      // 各类日志与报表，多个文件
  - BookStore.cpp (存在，但 Program 为主协调类)
  - utils/
    - Error.cpp                         // 报错
- data files (运行时生成)：
  - totalFile
  - AccountFile
  - BookFile
  - transactionLogFile
  - operationLogFile
  - financeReportFile
  - employeeReportFile
  - account_blocklinkedlist & account_blocklinkedlist_basicinformation
  - ISBN_book_blocklinkedlist & ISBN_book_blocklinkedlist_basicinformation
  - Author_book_blocklinkedlist & Author_book_blocklinkedlist_basicinformation
  - BookName_book_blocklinkedlist & BookName_book_blocklinkedlist_basicinformation
  - Keyword_book_blocklinkedlist & Keyword_book_blocklinkedlist_basicinformation
  - employeereport_blocklinkedlist & employeereport_blocklinkedlist_basicinformation

main 与类关系说明：
- 程序的启动入口（可在 main 或 Program 的外部创建逻辑）会构造 Program 对象（Program::Program），Program 在构造中打开 totalFile 并初始化 AccountManager、BookManager、LogManager（通过 setXXXManager）。
- Program 持有：
  - AccountManager accountmanager_; // 处理用户相关内容
  - BookManager bookmanager_; // 处理图书相关内容
  - LogManager logmanager_; // 处理日志相关内容
  - Parser parser; // 解析语句
  - std::vector<std::shared_ptr<Account>> loginStack; // 当前登录栈，用于 su/logout
  - std::fstream totalFile;
- Parser 负责解析后回调 Program 的方法（Program::Su, Program::Register, Program::Buy, Program::Select, Program::Modify, Program::Import, Program::Show 等）。
- 各 Manager 直接操作对应的二进制文件保存数据。

简化调用关系（示意）：
main -> Program
Program -> Parser (解析输入 -> 回调 Program)
Program -> AccountManager / BookManager / LogManager
Managers -> 对应二进制文件进行读写（持久化）

---

## 五、功能设计
模块划分（对应代码文件）：

- CLI 层
  - Parser：命令解析、参数校验（严格的格式检查规则）
  - Program：会话管理（loginStack）、命令分发、日志调用、程序生命周期

- 业务/持久化层（Managers）
  - AccountManager
    - 功能：添加/查找/删除/修改用户（addAccount, findAccount, getAccount, deleteAccount, changePassword）
    - 索引：accountList（基于 BlockLinkedList 或自定义索引结构）
    - 持久化文件：AccountFile（固定宽度记录用户信息）
                 account_blocklinkedlist & account_blocklinkedlist_basicinformation（用于记录userID与AccountFile中索引的对应）
  - BookManager
    - 功能：按 ISBN/name/author/keyword 查找（findBook、findBookName、findAuthor、findKeyword）、读取书目（getBook）、添加（addBook）、修改（modify）、变更库存（changeQuantity）、打印（printBook/printall）
    - 索引：ISBN_bookList、BookName_bookList、Author_bookList、Keyword_bookList
    - 辅助结构：sorted_index（std::map<isbn, index>）(将已有图书按isbn字典序排序，用于show所有书的时候)
    - 持久化文件：BookFile（固定宽度记录书本信息）
                 BookName_book_blocklinkedlist & BookName_book_blocklinkedlist_basicinformation（用于记录bookname与BookFile中索引的对应）
                 ISBN_book_blocklinkedlist & ISBN_book_blocklinkedlist_basicinformation（用于记录ISBN与BookFile中索引的对应）
                 Author_book_blocklinkedlist & Author_book_blocklinkedlist_basicinformation（用于记录author与BookFile中索引的对应）
                 Keyword_book_blocklinkedlist & Keyword_book_blocklinkedlist_basicinformation（用于记录keyword与BookFile中索引的对应）
  - LogManager
    - 功能：记录并展示 transaction log、operation log、finance log、employee log 
    - 持久化文件：transactionLogFile、operationLogFile、financeReportFile、employeeReportFile
                employeereport_blocklinkedlist & employeereport_blocklinkedlist_basicinformation（用于记录员工userid与employeeReportFile中索引的对应）
    - 提供统计（showTransaction、showFinanceLog、showEmployeeLog、showOperationLog）
- Utils
  - 错误类型 BookstoreError

功能结构图：
Program (运行核心，命令处理)
├─ Parser (解析命令 -> 回调 Program)
├─ AccountManager (账号 CRUD, 索引)
├─ BookManager (图书 CRUD/索引/库存)
└─ LogManager (日志/报表/事务记录)

主要命令
- 详见"标准要求.md"
---

## 六、数据库设计
采用若干固定格式的二进制文件（按 Manager 命名）。所有文件以固定宽度字段顺序写入，程序通过偏移量读/写记录。

总体元信息文件：totalFile  
- totalFile 中保存各管理器的元数据（例如 AccountManager 的 total_account、deleted list； BookManager 的 total_book 与 sorted index； LogManager 的各 total_ 值与 employee list 等）。
主要数据内容是各管理器的数据总量以及删除量（用于空间回收）
Program 在启动时读取这些信息来恢复各 Manager 状态，并在析构时写回。

具体文件及记录结构：

1) AccountFile（AccountManager）
- 单条记录结构：
  - username
  - userid
  - password
  - privilege
- 字节偏移量 = Accountsize * index
- 块状链表
  - account_blocklinkedlist：存储userid->index的映射
  - account_blocklinkedlist_basicinformation: 存储删除块（用于空间回收）以及account_blocklinkedlist的一些元数据（比如每个块最大值的缓存）
- 附加元数据：total_account (文件中存储的用户总量)、count_deleted_account (已删除的用户个数)、deleted_account 列表 (已删除用户的索引，用户空间回收)（写入到 totalFile）

2) BookFile（BookManager）
- 单条记录固定字段：
  - ISBN
  - bookname
  - author
  - keyword
  - quantity
  - price
- 字节偏移量 = Booksize * index
- 索引：
  - sorted_index: std::map<std::string, int> (isbn -> index)
  - 多个索引结构：ISBN_bookList、BookName_bookList、Author_bookList、Keyword_bookList（基于 BlockLinkedList结构）
- 元数据写入 totalFile：total_book（图书总量） 与 sorted_index（图书按照isbn字典序排序）

3) transactionLogFile
- 记录每笔“累计”交易（代码每次 addTransactionLog 将最新的 income/expenditure 写入一个条目）
- 单条大小：8 (income double) + 8 (expenditure double) = 16 bytes（transactionlogsize = 16）

4) operationLogFile
- 存储每条操作日志的文本（char[336]）及时间戳（6 个 int 分别记录 year, month, day, hour, minute, second）
- 单条大小：336 + 6*4 = 336 + 24 = 360 bytes（operationlogsize）

5) financeReportFile
- 存储每条财务明细：
  - userid: char[31]
  - ISBN: char[61]
  - quantity: int (4)
  - finance: double (8)
  - timestamp: 6 * int (year...second) = 24 bytes
- 单条大小：31+61+4+8+24 = 128 bytes（financelogsize）

6) employeeReportFile
- 存储员工（权限 == 3）操作记录：
  - log: char[311]
  - timestamp: 6 * int = 24 bytes
- 单条大小：311 + 24 = 335 bytes（employeelogsize）
- 另有 employeeReportList 索引（将 userid 映射到若干employeeReportFile中的index，用于查看某一员工的工作记录）
---

## 七、类 / 结构体设计
1) Account结构体（AccountManager 使用， 存储用户信息）
```
struct Account
{
    int index; //用户在AccountFile中的索引
    std::string username_;
    std::string userID_;
    std::string password_;
    int privilege_;
    int book_index = -1; // 用户所选择的图书的索引，-1表示未选中图书

    void printAccount(); // 输出Account内容（用于调试）
};
```

2) Book结构体（BookManager 使用，存储图书信息）
```
struct Book
{
    int index; // 图书在BookFile中的索引
    std::string ISBN_{""};
    std::string bookname_{""};
    std::string author_{""};
    std::string keyword_{""};
    int quantity_{0};
    double price_{0};
};
```
3) Block结构体（存储块，BlockLinkedList使用）
```
const int blocksize = 256; //块大小
struct Block
{
    std::string index[blocksize];
    int value[blocksize];
};
```
4) BlockLinkedList类（块状列表模板，int strlength为模板参数代表字符串长度，实现类似std::map的功能，存储字符串与数字的对应）
- 成员
```
template<int strlength>
class BlockLinkedList
{
  private:
    std::fstream file;
    std::string file_name;                // blocklinkedlist文件名，存储主体部分
    std::string file_name_;               // blocklinkedlist_basicinformation文件名，存储以下基本信息
    int head;                             // 首块索引
    int tail;                             // 尾块索引
    int countBlock;                       // 文件中存了几个Block
    std::vector<int> deletedBlock;        // 记录被删除的Block,用于空间回收
    int sizeofBlock = (4 + strlength + 1) * blocksize; // 块大小
    std::vector<std::string> blockmax_index; // 各块的最大值的字符串缓存（用于快速定位）
    std::vector<int> blockmax_value;         // 各块的最大值的数字缓存（用于快速定位）
    std::vector<int> next;                   // 各块的下一个块的索引缓存
    std::vector<int> last;                   // 各块的上一个块的索引缓存
    std::vector<int> count;                  // 各块的大小缓存

    void writeBlock(Block &block, int &index);             // 将Block写入文件
    Block getBlock(int &index);                            // 从文件中获得块
    void addBlock(Block &block, int index, int new_index); // 分配新块(将block加在index后)，index为-1时表示当前blocklinkedlist为空
    void deleteBlock(int index);                           // 删除块
    void mergeBlock(int index);                            // 合并块(index和index的下一个)
    void divideBlock(int index);                           // 分裂块
    void printblock(int index);                            // 输出块的内容(用于调试)
  public:
    void Insert(const std::string &index, int value); // 插入元素
    void Delete(const std::string &index, int value); // 删除元素
    std::vector<int> Find(const std::string &index);  // 查找元素，返回数字数组
    void printblocklinkedlist();                      // 输出列表状态（用于调试）
}
```
5) Program
- 成员：
```
class Program
{
  private:
    std::fstream totalFile;                             // 记录各Manager控制器的基本信息
    AccountManager accountmanager_;                     // 用户控制器
    BookManager bookmanager_;                           // 图书控制器
    LogManager logmanager_;                             // 日志控制器
    Parser parser;                                      // 解释器
    std::vector<std::shared_ptr<Account>> loginStack;   // 用户登录栈
    int book_index_now;                                 // 当前选定图书在BookFile中的索引
    
    bool programEnd_;                                   // 记录程序是否结束

    void sortBook(std::vector<int> &index);             // 将图书index按对应ISBN字典序排列的工具
    void printloginStack();                             // 输出登录栈（用于调试）
  public:
    Program();      // 构造函数，初始化数据并从文件中读取基本信息
    ~Program();     // 析构函数，将基本信息写入文件
    
    void execute(const std::string &line);              // 执行语句，实际上先交给parser解释器
    bool programRun();                                  // 返回程序是否正在运行

    void programEnd();                                  // 程序结束

    void Su(const std::string &userid, const std::string &password); // 用户登录
    void Logout();                                                   // 用户登出
    void Register(const std::string &userid, const std::string &password, const std::string &username);     // 用户注册
    void Passwd(const std::string &userid, const std::string &password1, const std::string &password2);    // 修改密码
    void Useradd(const std::string &userid, const std::string &password, int privilege, const std::string &username);   // 添加用户
    void Delete(const std::string &userid); // 删除用户

    void Show(Token type, const std::string &content); // 展示符合要求的书籍
    void Buy(const std::string &isbn, int quantity);   // 购买书籍
    void Select(const std::string &isbn);              // 选中书籍（包括添加图书）
    void Modify(const std::string &isbn, const std::string &bookname, const std::string &author, const std::string &keyword, std::vector<std::string> &keywords, double price, bool has_price);    // 改变书籍信息
    void Import(int quantity, double totalcost);       // 添加库存

    void ShowFinance(int count);                       // 店长获得支出统计
    void ReportFinance();                              // 店长获得财务报告
    void ReportEmployee();                             // 店长获得员工工作报告
    void ReportOperation();                            // 店长获得系统操作报告
};
```
6) Parser
```
class Parser
{
  public:
    void parseLine(const std::string &line, Program *program);  // 判断命令类型，分配语句

  private:
    // 语句解析分发
    void parseQuit    (int &pointer, const std::string &line, Program *program);
    void parseExit    (int &pointer, const std::string &line, Program *program);
    void parseSu      (int &pointer, const std::string &line, Program *program);
    void parseLogout  (int &pointer, const std::string &line, Program *program);
    void parseRegister(int &pointer, const std::string &line, Program *program);
    void parsePasswd  (int &pointer, const std::string &line, Program *program);
    void parseUseradd (int &pointer, const std::string &line, Program *program);
    void parseDelete  (int &pointer, const std::string &line, Program *program);
    void parseShow    (int &pointer, const std::string &line, Program *program);
    void parseBuy     (int &pointer, const std::string &line, Program *program);
    void parseSelect  (int &pointer, const std::string &line, Program *program);
    void parseModify  (int &pointer, const std::string &line, Program *program);
    void parseImport  (int &pointer, const std::string &line, Program *program);
    void parseLog     (int &pointer, const std::string &line, Program *program);
    void parseReport  (int &pointer, const std::string &line, Program *program);
};
```

7) BookManager 内索引器
```
class BookManager
{
  private:
    std::fstream bookFile;              // 储存图书信息的文件
    std::string bookfile_name;          // 文件路径
    int total_book;                     // 书籍总量
    static const int Booksize = 216;    // 每本书的信息的字节大小

    // 以下块状链表用于快速查找索引（基于BlockLinkedList）
    BlockLinkedList<20> ISBN_bookList{"ISBN_book_blocklinkedlist", "ISBN_book_blocklinkedlist_basicinformation"}; // ISBN->index块状链表
    BlockLinkedList<60> BookName_bookList{"BookName_book_blocklinkedlist", "BookName_book_blocklinkedlist_basicinformation"}; // BookName->index块状链表
    BlockLinkedList<60> Author_bookList{"Author_book_blocklinkedlist", "Author_book_blocklinedlist_basicinformation"}; // Author->index块状链表
    BlockLinkedList<60> Keyword_bookList{"Keyword_book_blocklinkedlist", "Keyword_book_blocklinkedlist_basicinformation"}; // Keyword->index块状链表

    std::map<std::string, int> sorted_index; // 将图书索引按对应ISBN的字典序排序，用于show所有图书时
    
  public:
    BookManager();
    ~BookManager();

    int setBookManager(std::fstream &totalFile, int point);     // 从totalFile中读取基本信息
    int recordBookManager(std::fstream &totalFile, int point);  // 将基本信息写入totalFile

    std::vector<int> findBookName(const std::string &bookname); // 按bookname查找，返回符合要求的索引
    std::vector<int> findAuthor(const std::string &author);     // 按author查找，返回符合要求的索引
    std::vector<int> findKeyword(const std::string &keyword);   // 按keyword查找，返回符合要求的索引

    int findBook(const std::string &isbn);                      // 返回ISBN对应索引
    std::shared_ptr<Book> getBook(int index);                   // 获得索引对应图书的指针
    std::shared_ptr<Book> getBook(const std::string &isbn);     // 获得ISBN对应图书的指针
    std::string getISBN(int index);                             // 获得索引对应图书的ISBN
    double getPrice(int index);                                 // 获得索引对应图书的价格

    void changeQuantity(int index, int delta_quantity);         // 改变索引对应图书的数量
    void modify(int index, const std::string &isbn, const std::string &bookname, const std::string &author, const std::string &keyword, std::vector<std::string> &keywords, double &price, bool has_price);       // 改变索引对应图书的各种信息
    int addBook(const std::string &isbn);                       // 添加图书

    void printBook(int index);                                  // 输出图书内容
    void printall();                                            // 输出所有图书的内容
};
```
8) LogManager
- 管理多个日志文件和计数（total_transactionlog、total_operationlog、total_financelog、total_employeelog）
- employee_userid：员工列表（写入 totalFile）
```
class LogManager
{
  private:
    std::fstream transactionLogFile;      // 交易日志文件路径
    std::fstream financeReportFile;       // 财务报表文件路径
    std::fstream employeeReportFile;      // 员工报告文件路径
    std::fstream operationLogFile;        // 操作日志文件路径

    int total_transactionlog;             // 交易日志条数
    int total_financelog;                 // 财务日志条数
    int total_employeelog;                // 员工日志条数
    int total_operationlog;               // 操作日志条数

    std::vector<std::string> employee_userid;    // 员工userid
    BlockLinkedList<30> employeeReportList{"employeereport_blocklinkedlist", "employeereport_blocklinkedlist_basicinformation"}; // 员工userid与employeeReportFile中索引的块状链表

    static const int transactionlogsize = 16;    // 交易日志单条字节大小
    static const int financelogsize = 128;       // 财务日志单条字节大小
    static const int employeelogsize = 335;      // 员工日志单条字节大小
    static const int operationlogsize = 360;     // 操作日志单条字节大小
  public:
    LogManager();
    ~LogManager();

    int setLogManager(std::fstream &totalFile, int point);       // 从totalFile中读取基本信息
    int recordLogManager(std::fstream &totalFile, int point);    // 将基本信息写入totalFile

    void addEmployee(const std::string &userid);                 // 添加新员工（加入统计队列）
    
    void addTransactionLog(double finance);                      // 添加交易日志
    void showTransaction(int count);                             // 输出交易统计

    void addFinanceLog(const std::string &userid, const std::string &isbn, int quantity, double finance);               // 添加财务日志
    void showFinanceLog();         // 输出财务报表

    void addEmployeeLog(int privilege, const std::string &userid, const std::string &old_isbn, const std::string &isbn, const std::string &bookname, const std::string &author, const std::string &keyword, double price, bool has_price);  // 添加员工日志
    void addEmployeeLog(int privilege, const std::string &userid, const std::string &isbn, int quantity, double totalcost);      // 添加员工日志
    void showEmployeeLog();        // 输出员工工作统计

    void addOperationLog(const std::string &log);   // 添加系统操作日志
    void showOperationLog();                        // 输出系统操作日志
};
```
---

## 八、补充说明
`在日志部分LogManager管理器中，获取当前时间的部分代码是在AI的帮助下完成的`